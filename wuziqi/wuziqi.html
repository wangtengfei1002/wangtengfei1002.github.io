<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
	</head>
	<style>
		*{
			margin:0;
			padding:0;
			list-style: none;
		}
		body,html{
			height: 100%;
			width: 100%;
			background-image: url(timg.jpg);
			background-size:contain;
			background-repeat: no-repeat;
			background-position: center;
		}
		canvas{
			border:1px solid #bbb;
			position: absolute;
			left:0;
			top:0;
			right:0;
			bottom:0;
			margin:auto;
			background: #fff;
		}
		.box{
			width: 600px;
			height: 600px;
			background: #FFFFFF;
			position: absolute;
			left:0;
			right:0;
			top:0;
			bottom:0;
			margin:auto;
			z-index: 10;
			box-shadow: 0 0 0 900px rgba(0,0,0,0.8);
			transform: scale(0,0);
			transition: transform 1s ease;
		}
		button{
			border:none;
			background: #FF4400;
			position: absolute;
			top:10px;
			left:10px;
			z-index: 10;
			color:#fff;
			
		}
		.box.active{
			transform: scale(1,1);
			
		}
		.box a{
			position: absolute;
			left:0;
			right:0;
			top:0;
			bottom:0;
			margin:auto;
		}
		button{
			position: absolute;
			left:50%;
			top:10%;
			z-index: 999999999999;
		}
	</style>
	<body>
		<button>查看棋谱</button>
		<canvas height="600" width="600"></canvas>
		<div class="box"></div>
	</body>
</html>
<script type="text/javascript">
	let btn=document.querySelector('button');
	let box=document.querySelector('.box');
	let canvas=document.querySelector('canvas');
	let ctx=canvas.getContext('2d');
	let flag=true;
	let arr=[];
	drawLine();
	function drawLine(){
		//清空画布  保存   画线   恢复   
		ctx.clearRect(0,0,600,600);
		arr=[];
		ctx.save();
		ctx.beginPath();
		for(let i=0;i<15;i++){
			ctx.moveTo(line(0),line(i));
			ctx.lineTo(line(14),line(i));
			ctx.moveTo(line(i),line(0));
			ctx.lineTo(line(i),line(14));
		}
		ctx.closePath();
		ctx.stroke();
		circle(line(7),line(7))
		circle(line(3),line(3))
		circle(line(11),line(3))
		circle(line(3),line(11))
		circle(line(11),line(11))
	};
	canvas.onclick=function(e){
		let ox=Math.floor(e.offsetX/40),
			oy=Math.floor(e.offsetY/40);
		if(arr[m(ox,oy)]){
			return
		}

		//切换颜色
		if(flag){
			drawChress(ox,oy,'#000000')
			if(check(ox,oy,'#000000')>=5){
				alert('黑方胜');
				drawLine()
			}
			
		}else{
			drawChress(ox,oy,'red')
			if( check(ox,oy,'red')>=5){
				alert('红方胜');
				drawLine()
			}
			
		}
	}
	
	btn.onclick=function(){
		box.classList.toggle('active');
		let imgdata=canvas.toDataURL('image/png');
		let img=new Image();
		img.src=imgdata;
		img.onload=function(){
			if(box.childNodes.length==2){
				box.removeChild(box.firstChild);
				box.removeChild(box.lastChild)
			}
			box.appendChild(img);				
			
			let a=document.createElement('a');
				a.href=imgdata;
				a.download='qipan.png';
				box.appendChild(a);	
		}
		
	}
	
				
	function line(x){
		return 40*x+20
	}
	function circle(x,y){
		ctx.save();
		ctx.translate(x,y);
		ctx.beginPath();
		ctx.arc(0,0,5,0,Math.PI*2);
		ctx.closePath();
		ctx.fill();
		ctx.restore();
	}
	function drawChress(x,y,color){
		ctx.save();
		ctx.translate(line(x),line(y));
	
		ctx.beginPath();
		ctx.fillStyle=color
		ctx.arc(0,0,20,0,Math.PI*2);
		ctx.closePath();
		ctx.fill();
		ctx.restore();
		flag=!flag;
		arr[m(x,y)]=color;
	};
	function m(x,y){
		return `${x}_${y}`;
		//把每次点的颜色存起来
	}
	function check(x,y,color){
		let row=1;
		let i=1;
		while(arr[m(x+i,y)]==color){
			row++;
			i++;	
		}
		i=1;
		while(arr[m(x-i,y)]==color){
			row++;
			i++;	
		}
		i=1
		let cols=1;
		while(arr[m(x,y+i)]==color){
			cols++;
			i++;	
		}
		i=1;
		while(arr[m(x,y-i)]==color){
			cols++;
			i++;	
		}
		i=1
		let zx=1;
		while(arr[m(x+i,y+i)]==color){
			zx++;
			i++;	
		}
		i=1;
		while(arr[m(x-i,y-i)]==color){
			zx++;
			i++;	
		}
		i=1
		let yx=1;
		while(arr[m(x-i,y+i)]==color){
			yx++;
			i++;	
		}
		i=1;
		while(arr[m(x+i,y-i)]==color){
			yx++;
			i++;	
		}
		return Math.max(row,cols,zx,yx)
	}
</script>